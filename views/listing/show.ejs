<% layout("layout/biolerplate") %>

<div class="container mt-5">

    <h2 class="text-center mb-4"><%= listings.title %></h2>

    <div class="card show-card col-md-8 mx-auto listing-card">

        <!-- IMAGE CAROUSEL -->
        <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <% listings.images.forEach((img, index) => { %>
                    <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                        <img src="<%= img.url %>" class="d-block w-100 rounded" alt="">
                    </div>
                <% }) %>
            </div>

            <button class="carousel-control-prev" type="button"
                    data-bs-target="#listingCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </button>

            <button class="carousel-control-next" type="button"
                    data-bs-target="#listingCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
            </button>

            <div class="carousel-indicators">
                <% listings.images.forEach((img, index) => { %>
                    <button type="button"
                            data-bs-target="#listingCarousel"
                            data-bs-slide-to="<%= index %>"
                            class="<%= index === 0 ? 'active' : '' %>"></button>
                <% }) %>
            </div>
        </div>

        <dl class="form-control mt-3">
            <dt>Owned by:</dt>
            <dd><%= listings.owner.username %></dd>

            <dt>Description:</dt>
            <dd><%= listings.description %></dd>

            <dt>Price:</dt>
            <dd>&#8377;<%= listings.price %></dd>

            <dt>Location:</dt>
            <dd><%= listings.location %></dd>

            <dt>Country:</dt>
            <dd><%= listings.country %></dd>
        </dl>

        <% if (currUser && listings.owner._id.equals(currUser._id)) { %>
            <a href="/listing/<%= listings._id %>/edit" class="btn btn-outline-dark">Edit</a>

            <form method="POST"
                  action="/listing/<%= listings._id %>?_method=DELETE"
                  class="d-inline">
                <button class="btn btn-dark">Delete</button>
            </form>
        <% } %>

        <form action="/listing/<%= listings._id %>/book" class="mt-3">
            <button class="book btn btn-success">Book Now</button>
        </form>

    </div>

    <!-- REVIEWS SECTION -->
    <% if (currUser) { %>
        <div class="col-md-8 mx-auto mt-4">
            <hr>
            <h4>Leave a Review</h4>

            <form action="/listing/<%= listings._id %>/reviews" method="post">
                <textarea name="review[comment]" class="form-control" required></textarea>
                <button class="btn btn-outline-dark mt-2">Submit</button>
            </form>
        </div>
    <% } %>

    <% if (listings.reviews.length) { %>
        <div class="col-md-8 mx-auto mt-4">
            <h4>All Reviews</h4>
            <% listings.reviews.forEach(review => { %>
                <div class="card p-3 mb-3">
                    <h5>@<%= review.author.username %></h5>
                    <p><%= review.comment %></p>

                    <% if (currUser && review.author._id.equals(currUser._id)) { %>
                        <form method="POST"
                              action="/listing/<%= listings._id %>/reviews/<%= review._id %>?_method=DELETE">
                            <button class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    <% } %>
                </div>
            <% }) %>
        </div>
    <% } %>

</div>
